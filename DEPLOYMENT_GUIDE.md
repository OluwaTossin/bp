# Deployment Guide - Blood Pressure Calculator

This guide explains how to deploy the Blood Pressure Calculator application to AWS from scratch.

## üöÄ Quick Start (New Clone)

If you've just cloned this repository, follow these steps:

### 1. Prerequisites

Install required tools:
- **.NET 8.0 SDK**: https://dotnet.microsoft.com/download
- **AWS CLI**: https://aws.amazon.com/cli/
- **Terraform**: https://www.terraform.io/downloads
- **Git**: https://git-scm.com/
- **jq**: `sudo apt-get install jq` (Linux) or `brew install jq` (Mac)

### 2. Configure AWS Credentials

```bash
aws configure
```

Enter your AWS credentials:
- AWS Access Key ID
- AWS Secret Access Key
- Default region: `eu-west-1` (or your preferred region)
- Default output format: `json`

### 3. Bootstrap AWS Environment

Run the bootstrap script to set up the Terraform backend:

```bash
chmod +x bootstrap.sh
./bootstrap.sh
```

This will:
- Create S3 bucket for Terraform state
- Create DynamoDB table for state locking
- Configure Terraform backend
- Generate environment configuration files
- Create `.env` file with your settings

### 4. Deploy to Staging

```bash
chmod +x deploy.sh
./deploy.sh staging
```

This will:
- Build and test the application
- Create deployment package
- Deploy infrastructure with Terraform
- Deploy application to Elastic Beanstalk
- Run health checks

### 5. Access Your Application

After deployment completes, you'll see the application URL:
```
URL: http://bp-calculator-staging-XXXXXXXXXX.eu-west-1.elasticbeanstalk.com
```

---

## üìã Detailed Steps

### Bootstrap Script (`bootstrap.sh`)

The bootstrap script performs one-time setup:

1. **Checks Prerequisites**: Verifies required tools are installed
2. **Creates Terraform Backend**:
   - S3 bucket: `bp-calculator-tfstate-<timestamp>`
   - DynamoDB table: `bp-calculator-locks`
   - Enables versioning, encryption, and public access blocking
3. **Generates Configuration Files**:
   - `infra/backend-config.tfvars` - Terraform backend config
   - `infra/env/staging.tfvars` - Staging environment variables
   - `infra/env/prod.tfvars` - Production environment variables
   - `.env` - Local environment variables
4. **Initializes Terraform**: Runs `terraform init` with backend config

**Usage:**
```bash
./bootstrap.sh
```

**What gets created:**
- `.env` - Your local configuration (DO NOT commit!)
- `infra/backend-config.tfvars` - Terraform backend settings
- `infra/env/*.tfvars` - Environment-specific variables

---

### Deploy Script (`deploy.sh`)

The deploy script handles application deployment:

**Usage:**
```bash
./deploy.sh [staging|prod|all]
```

**Examples:**
```bash
./deploy.sh staging    # Deploy to staging only
./deploy.sh prod       # Deploy to production only
./deploy.sh all        # Deploy to both environments
```

**Steps:**
1. Checks prerequisites and runs bootstrap if needed
2. Restores .NET dependencies
3. Builds application (Release configuration)
4. Runs all tests (62 tests: 36 unit + 26 BDD)
5. Publishes application
6. Creates deployment ZIP package
7. Deploys infrastructure with Terraform
8. Uploads package to S3
9. Creates Elastic Beanstalk application version
10. Deploys to Elastic Beanstalk environment
11. Waits for deployment to complete
12. Runs health checks

**Configuration:**
- Loads settings from `.env` file
- Uses environment-specific tfvars files
- Auto-detects first-time deployment

---

### Destroy Script (`destroy.sh`)

The destroy script tears down AWS resources:

**Usage:**
```bash
./destroy.sh [staging|prod|all] [--auto-approve]
```

**Examples:**
```bash
./destroy.sh staging              # Destroy staging (with confirmation)
./destroy.sh all --auto-approve   # Destroy everything (no confirmation)
```

**Steps:**
1. Backs up Terraform state
2. Terminates Elastic Beanstalk environments
3. Deletes application versions
4. Empties S3 buckets
5. Runs `terraform destroy`
6. Deletes CloudWatch log groups
7. Optionally destroys Terraform backend (S3 + DynamoDB)
8. Cleans up local files

**‚ö†Ô∏è Warning**: This is **destructive** and will delete all resources!

---

## üîß Configuration Files

### `.env` (Generated by bootstrap)
```bash
TF_STATE_BUCKET=bp-calculator-tfstate-1234567890
TF_STATE_TABLE=bp-calculator-locks
AWS_REGION=eu-west-1
AWS_ACCOUNT_ID=123456789012
APP_NAME=bp-calculator
```

### `infra/backend-config.tfvars` (Generated by bootstrap)
```hcl
bucket         = "bp-calculator-tfstate-1234567890"
key            = "bp-calculator/terraform.tfstate"
region         = "eu-west-1"
dynamodb_table = "bp-calculator-locks"
encrypt        = true
```

### `infra/env/staging.tfvars` (Generated by bootstrap)
```hcl
environment        = "staging"
region             = "eu-west-1"
instance_type      = "t3.micro"  # Free tier
app_name           = "bp-calculator"
enable_monitoring  = true
log_retention_days = 7
```

### `infra/env/prod.tfvars` (Generated by bootstrap)
```hcl
environment        = "prod"
region             = "eu-west-1"
instance_type      = "t3.small"  # Production sizing
app_name           = "bp-calculator"
enable_monitoring  = true
log_retention_days = 30
```

---

## üîê GitHub Actions CI/CD

### GitHub Secrets Setup

After running bootstrap, add these secrets to your GitHub repository:

**Navigation**: Settings > Secrets and variables > Actions > New repository secret

**Required Secrets:**
```
AWS_ACCESS_KEY_ID     = <your-aws-access-key>
AWS_SECRET_ACCESS_KEY = <your-aws-secret-key>
AWS_REGION            = eu-west-1
AWS_ACCOUNT_ID        = 123456789012
```

### CI Pipeline (`.github/workflows/ci.yml`)

Triggers on:
- Push to `main` or `develop`
- Pull requests to `main`
- Manual workflow dispatch

**Jobs:**
1. **build-and-test**: Compile and run 62 tests
2. **security-scan**: Check for vulnerabilities
3. **code-quality**: Verify formatting compliance
4. **summary**: Aggregate results

### CD Pipeline (`.github/workflows/cd.yml`)

Triggers on:
- Push to `main` branch
- Manual workflow dispatch

**Jobs:**
1. **build-package**: Create deployment artifact
2. **deploy-infrastructure**: Apply Terraform changes
3. **deploy-staging**: Deploy to staging environment
4. **smoke-tests**: Verify deployment health

---

## üåç Deployed AWS Resources

### Staging Environment
- **Elastic Beanstalk Application**: `bp-calculator`
- **Elastic Beanstalk Environment**: `bp-calculator-staging`
- **Instance Type**: t3.micro (free tier eligible)
- **Platform**: .NET 8 on Amazon Linux 2023
- **S3 Bucket**: `bp-calculator-eb-artifacts-staging`
- **CloudWatch Log Group**: `bp-calculator-logs`
- **CloudWatch Alarms**: CPU, Unhealthy Hosts, 5xx Errors
- **SNS Topic**: `bp-calculator-alarms-staging`

### Production Environment
- **Elastic Beanstalk Environment**: `bp-calculator-prod`
- **Instance Type**: t3.small
- **S3 Bucket**: `bp-calculator-eb-artifacts-prod`
- **CloudWatch Log Group**: `/aws/elasticbeanstalk/bp-calculator-prod`
- **CloudWatch Alarms**: CPU, Unhealthy Hosts, 5xx Errors
- **SNS Topic**: `bp-calculator-alarms-prod`

### Terraform Backend
- **S3 Bucket**: `bp-calculator-tfstate-<timestamp>`
- **DynamoDB Table**: `bp-calculator-locks`

---

## üí∞ Cost Estimation

**Monthly costs (approximate):**

| Service | Staging | Production | Total |
|---------|---------|------------|-------|
| EC2 (Elastic Beanstalk) | $8 (t3.micro) | $15 (t3.small) | $23 |
| S3 Storage | <$0.10 | <$0.10 | <$0.20 |
| DynamoDB | <$0.01 | <$0.01 | <$0.02 |
| CloudWatch Logs | $1-2 | $2-3 | $3-5 |
| Data Transfer | $1-2 | $2-3 | $3-5 |
| **Total** | **~$10-12** | **~$19-21** | **~$29-33** |

**Cost Optimization:**
- Use AWS Free Tier (12 months): 750 hours/month t2.micro or t3.micro
- Destroy staging when not in use: `./destroy.sh staging`
- Set CloudWatch log retention to 7 days for staging
- Use scheduled scaling for non-production environments

---

## üß™ Testing

### Local Testing
```bash
# Run all tests
dotnet test

# Run with coverage
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura

# Run only unit tests
dotnet test --filter "FullyQualifiedName~BloodPressureTests"

# Run only BDD tests
dotnet test --filter "FullyQualifiedName~BloodPressureClassificationFeature"
```

### Test Results
```
Total Tests:  62 (36 unit + 26 BDD)
Passed:       62 ‚úì
Failed:       0
Skipped:      0
Duration:     101ms
Coverage:     100% (BloodPressure class)
```

---

## üîç Monitoring & Logs

### View CloudWatch Logs
```bash
# Staging
aws logs tail /aws/elasticbeanstalk/bp-calculator-staging --follow --region eu-west-1

# Production
aws logs tail /aws/elasticbeanstalk/bp-calculator-prod --follow --region eu-west-1
```

### View Application Status
```bash
# Staging
aws elasticbeanstalk describe-environments \
  --environment-names bp-calculator-staging \
  --region eu-west-1

# Production
aws elasticbeanstalk describe-environments \
  --environment-names bp-calculator-prod \
  --region eu-west-1
```

### Health Checks
```bash
# Staging URL
curl -I http://bp-calculator-staging.eba-XXXXXXXX.eu-west-1.elasticbeanstalk.com

# Should return: HTTP/1.1 200 OK
```

---

## üîÑ Update Workflow

### Deploy New Changes

1. **Make code changes**
2. **Commit to feature branch**
   ```bash
   git checkout -b feature/my-new-feature
   git add .
   git commit -m "feat: Add new feature"
   git push origin feature/my-new-feature
   ```
3. **Create Pull Request** - CI pipeline runs automatically
4. **Merge to main** - CD pipeline deploys to staging
5. **Manual production deployment** (if needed)
   ```bash
   ./deploy.sh prod
   ```

### Rollback

```bash
# List versions
aws elasticbeanstalk describe-application-versions \
  --application-name bp-calculator \
  --region eu-west-1

# Deploy previous version
aws elasticbeanstalk update-environment \
  --environment-name bp-calculator-staging \
  --version-label <previous-version> \
  --region eu-west-1
```

---

## üêõ Troubleshooting

### Bootstrap Issues

**Problem**: "AWS credentials not configured"
```bash
aws configure
```

**Problem**: "terraform: command not found"
```bash
# Mac
brew install terraform

# Linux
wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
unzip terraform_1.6.0_linux_amd64.zip
sudo mv terraform /usr/local/bin/
```

### Deployment Issues

**Problem**: "Backend configuration not found"
```bash
./bootstrap.sh  # Run bootstrap first
```

**Problem**: "Deployment package not found"
- Ensure build completed successfully
- Check for `bp-app-*.zip` in project root

**Problem**: "Environment creation timeout"
- Check AWS Console for detailed error
- Review CloudWatch logs
- Increase timeout in deploy script

### Terraform Issues

**Problem**: "State lock error"
```bash
# Force unlock (use carefully!)
cd infra
terraform force-unlock <lock-id>
```

**Problem**: "Resource already exists"
```bash
# Import existing resource
terraform import <resource-type>.<name> <resource-id>
```

---

## üßπ Clean Up

### Destroy Staging Only
```bash
./destroy.sh staging
```

### Destroy Everything
```bash
./destroy.sh all
```

### Complete Cleanup (including backend)
```bash
./destroy.sh all

# Then manually delete backend (if prompted):
aws s3 rb s3://bp-calculator-tfstate-XXXXXXXXXX --force
aws dynamodb delete-table --table-name bp-calculator-locks --region eu-west-1
```

---

## üìö Additional Resources

- [AWS Elastic Beanstalk Documentation](https://docs.aws.amazon.com/elasticbeanstalk/)
- [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [.NET 8.0 Documentation](https://docs.microsoft.com/en-us/dotnet/core/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)

---

## üÜò Support

For issues or questions:
1. Check [Troubleshooting](#-troubleshooting) section
2. Review CloudWatch logs
3. Check AWS Console for resource status
4. Review GitHub Actions logs for CI/CD issues

---

**Last Updated**: November 27, 2025  
**Version**: 1.0.0
